WITH OrderedData AS (
    SELECT
        hh_id_in_wh,
        pwm_relat,
        business_date,
        LAG(pwm_relat) OVER (PARTITION BY hh_id_in_wh ORDER BY business_date) AS prev_pwm_relat,
        LAG(business_date) OVER (PARTITION BY hh_id_in_wh ORDER BY business_date) AS prev_business_date
    FROM your_table
),
SwitchPoints AS (
    SELECT
        hh_id_in_wh,
        pwm_relat,
        business_date,
        prev_pwm_relat,
        prev_business_date
    FROM OrderedData
    WHERE pwm_relat = '1' AND prev_pwm_relat = '0'
),
ValidSwitches AS (
    SELECT DISTINCT
        sp.hh_id_in_wh,
        FIRST_VALUE(sp.business_date) OVER (PARTITION BY sp.hh_id_in_wh ORDER BY sp.business_date) AS switch_date
    FROM SwitchPoints sp
    WHERE NOT EXISTS (
        SELECT 1
        FROM OrderedData od
        WHERE od.hh_id_in_wh = sp.hh_id_in_wh
        AND od.pwm_relat = '1'
        AND od.business_date BETWEEN sp.prev_business_date - INTERVAL '6 months' AND sp.prev_business_date
    )
)
SELECT *
FROM ValidSwitches;
